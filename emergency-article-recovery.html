<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergency Article Recovery</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .alert { background: #ffebee; border: 1px solid #f44336; color: #c62828; padding: 15px; border-radius: 4px; margin-bottom: 20px; }
        .success { background: #e8f5e8; border: 1px solid #4caf50; color: #2e7d32; }
        button { background: #2196f3; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; margin: 10px 5px; }
        button:hover { background: #1976d2; }
        .danger { background: #f44336; }
        .danger:hover { background: #d32f2f; }
        .success-btn { background: #4caf50; }
        .success-btn:hover { background: #388e3c; }
        #log { background: #f5f5f5; border: 1px solid #ddd; padding: 15px; height: 300px; overflow-y: auto; font-family: monospace; white-space: pre-wrap; }
        .article-list { background: #f9f9f9; border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üÜò Emergency Article Recovery Tool</h1>
        
        <div class="alert">
            <strong>IMPORTANT:</strong> This tool will help you recover articles that were stored in your browser's localStorage and migrate them to the new backend system.
        </div>

        <h2>Step 1: Check for Existing Articles</h2>
        <button onclick="checkLocalStorage()">üîç Search for Articles in Browser Storage</button>
        
        <div id="found-articles" style="display: none;">
            <h3>Found Articles:</h3>
            <div id="article-list" class="article-list"></div>
            
            <h2>Step 2: Recovery Options</h2>
            <button onclick="recoverArticles()" class="success-btn">‚úÖ Migrate All Articles to Backend</button>
            <button onclick="exportArticles()" class="success-btn">üíæ Download Articles as Backup</button>
        </div>

        <div id="no-articles" style="display: none;" class="alert">
            No articles found in localStorage. They might have already been migrated or stored elsewhere.
        </div>

        <h2>Recovery Log</h2>
        <div id="log">Click "Search for Articles" to begin...\n</div>

        <h2>Manual Recovery</h2>
        <p>If automatic recovery doesn't work, you can manually check these localStorage keys:</p>
        <button onclick="checkAllKeys()">üîß Show All LocalStorage Keys</button>
        <button onclick="clearLog()">üóëÔ∏è Clear Log</button>
    </div>

    <script>
        let foundArticles = [];
        
        function log(message) {
            const logElement = document.getElementById('log');
            logElement.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
            logElement.scrollTop = logElement.scrollHeight;
        }

        function checkLocalStorage() {
            log('üîç Searching for articles in localStorage...');
            foundArticles = [];
            
            // Check common localStorage keys
            const possibleKeys = ['blog-articles', 'blog-articles-cache', 'articles', 'blogArticles'];
            
            for (const key of possibleKeys) {
                const stored = localStorage.getItem(key);
                if (stored) {
                    try {
                        const parsed = JSON.parse(stored);
                        if (Array.isArray(parsed) && parsed.length > 0) {
                            // Check if items look like articles
                            const validArticles = parsed.filter(item => 
                                item && typeof item === 'object' && 
                                item.title && item.content && item.author
                            );
                            
                            if (validArticles.length > 0) {
                                log(`‚úÖ Found ${validArticles.length} articles in key: ${key}`);
                                foundArticles = [...foundArticles, ...validArticles];
                            }
                        }
                    } catch (e) {
                        log(`‚ùå Error parsing key ${key}: ${e.message}`);
                    }
                } else {
                    log(`‚ÑπÔ∏è No data found in key: ${key}`);
                }
            }
            
            // Remove duplicates based on ID or title
            const uniqueArticles = foundArticles.filter((article, index, self) => 
                index === self.findIndex(a => a.id === article.id || a.title === article.title)
            );
            foundArticles = uniqueArticles;
            
            if (foundArticles.length > 0) {
                log(`üéâ Total unique articles found: ${foundArticles.length}`);
                displayFoundArticles();
                document.getElementById('found-articles').style.display = 'block';
                document.getElementById('no-articles').style.display = 'none';
            } else {
                log('‚ùå No articles found in any localStorage key');
                document.getElementById('found-articles').style.display = 'none';
                document.getElementById('no-articles').style.display = 'block';
            }
        }

        function displayFoundArticles() {
            const listElement = document.getElementById('article-list');
            listElement.innerHTML = foundArticles.map((article, index) => `
                <div style="border-bottom: 1px solid #eee; padding: 10px 0;">
                    <strong>${index + 1}. ${article.title}</strong><br>
                    <small>By: ${article.author} | Published: ${article.publishDate || 'Unknown'}</small><br>
                    <small>Content preview: ${(article.content || '').substring(0, 100)}...</small>
                </div>
            `).join('');
        }

        async function recoverArticles() {
            if (foundArticles.length === 0) {
                alert('No articles to recover. Please search for articles first.');
                return;
            }

            log(`üöÄ Starting recovery of ${foundArticles.length} articles...`);
            let recovered = 0;
            let failed = 0;

            for (const article of foundArticles) {
                try {
                    log(`üìù Recovering: "${article.title}"`);
                    
                    const response = await fetch('/api/blog', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(article),
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.status === 'success') {
                            log(`‚úÖ Recovered: "${article.title}"`);
                            recovered++;
                        } else {
                            log(`‚ö†Ô∏è Partial success for "${article.title}": ${result.message}`);
                            recovered++;
                        }
                    } else {
                        log(`‚ùå Failed to recover "${article.title}": HTTP ${response.status}`);
                        failed++;
                    }
                } catch (error) {
                    log(`‚ùå Error recovering "${article.title}": ${error.message}`);
                    failed++;
                }

                // Small delay to avoid overwhelming the server
                await new Promise(resolve => setTimeout(resolve, 200));
            }

            log(`\nüéâ Recovery complete!`);
            log(`‚úÖ Successfully recovered: ${recovered} articles`);
            log(`‚ùå Failed to recover: ${failed} articles`);

            if (recovered > 0) {
                log(`\nüîÑ Articles have been saved to the backend. You can now access them from any browser!`);
                if (confirm('Recovery complete! Would you like to refresh the page to see your recovered articles?')) {
                    window.location.reload();
                }
            }
        }

        function exportArticles() {
            if (foundArticles.length === 0) {
                alert('No articles to export. Please search for articles first.');
                return;
            }

            const exportData = {
                exportDate: new Date().toISOString(),
                articleCount: foundArticles.length,
                articles: foundArticles
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `blog-articles-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            log(`üíæ Exported ${foundArticles.length} articles to JSON file`);
        }

        function checkAllKeys() {
            log('üîß Checking all localStorage keys...');
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                log(`Key: ${key} | Size: ${value ? value.length : 0} chars`);
                
                if (key && (key.includes('blog') || key.includes('article'))) {
                    log(`   ‚≠ê This key might contain blog data!`);
                }
            }
        }

        function clearLog() {
            document.getElementById('log').textContent = 'Log cleared.\n';
        }

        // Auto-run search on page load
        window.onload = function() {
            log('üîÑ Tool loaded. Click "Search for Articles" to begin recovery.');
        };
    </script>
</body>
</html>
